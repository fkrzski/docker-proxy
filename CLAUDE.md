# CLAUDE.md

## Project Overview

**Local Docker Proxy with Traefik & HTTPS** is a development infrastructure tool that provides a centralized reverse proxy solution for local Docker-based development environments. It eliminates port conflicts and provides trusted SSL certificates for local domains.

### Core Purpose
- Single Traefik container handles routing for all local Docker projects
- Custom domain routing (e.g., `https://my-app.docker.localhost`)
- Automatic HTTPS with trusted local SSL certificates
- Optional pre-configured services: Redis, MySQL, phpMyAdmin

### Target Users
Developers working with multiple Docker-based projects who need:
- Consistent local domain naming
- HTTPS support in development
- Centralized service management
- No port collision management

## Project Structure

```
.
├── certs/                    # SSL certificates (generated by mkcert)
│   ├── .gitkeep             # Keeps directory in git
│   ├── local-cert.pem       # Certificate file (git-ignored)
│   └── local-key.pem        # Private key (git-ignored)
├── config/                   # Traefik configuration
│   └── dynamic.yml          # TLS certificate configuration
├── .env.example             # Environment template
├── .env                     # Active environment config (git-ignored)
├── docker-compose.yml       # Main service definitions
├── setup.sh                 # Automated installation script
├── .gitignore              # Git ignore rules
├── LICENSE                  # MIT License
└── README.md               # User documentation
```

## Key Components

### 1. Traefik (Core Service)
- **Container**: Always running reverse proxy
- **Ports**: 80 (HTTP), 443 (HTTPS)
- **Dashboard**: `https://traefik.docker.localhost`
- **Configuration**: Command-line flags in docker-compose.yml
- **Features**:
  - Automatic HTTP → HTTPS redirect
  - Docker provider with label-based routing
  - Dynamic configuration from `/config`
  - API dashboard enabled

### 2. Optional Services (Profile-based)
All optional services are controlled via `COMPOSE_PROFILES` in `.env`:

- **Redis** (`redis` profile)
  - Image: `redis:alpine`
  - No exposed ports (accessed via network)
  
- **MySQL** (`mysql` profile)
  - Image: `mysql:8.0`
  - Persistent volume: `mysql_data`
  - Configurable root password via env var
  
- **phpMyAdmin** (`pma` profile)
  - Image: `phpmyadmin/phpmyadmin`
  - URL: `https://pma.docker.localhost`
  - Depends on MySQL service

### 3. SSL Certificate Management
- Uses `mkcert` for local CA generation
- Certificates cover:
  - `localhost`
  - `*.docker.localhost` (wildcard)
  - `127.0.0.1`
  - `::1` (IPv6 localhost)
- Certificates stored in `./certs` directory
- Referenced in Traefik via dynamic config

### 4. Docker Network
- **Name**: `traefik-proxy`
- **Type**: External bridge network
- **Purpose**: Allows containers from different compose projects to communicate
- **Usage**: Projects must declare this as external network

## Configuration Details

### Environment Variables (.env)
```dotenv
COMPOSE_PROFILES=redis,mysql,pma  # Controls which services start
MYSQL_ROOT_PASSWORD=root          # MySQL root password
```

### Traefik Labels Pattern
Projects using this proxy must use labels:
```yaml
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.<name>.rule=Host(`<domain>.docker.localhost`)"
  - "traefik.http.routers.<name>.tls=true"
  # Optional: if service runs on non-80 port
  - "traefik.http.services.<name>.loadbalancer.server.port=<port>"
```

## Setup Process (setup.sh)

The script performs these steps:

1. **Dependency Check**: Verifies/installs `libnss3-tools` and `curl`
2. **mkcert Installation**: Downloads and installs if not present
3. **CA Initialization**: Runs `mkcert -install` to create local CA
4. **Network Creation**: Creates `traefik-proxy` Docker network
5. **Certificate Generation**: Creates SSL certs for local domains
6. **Environment Setup**: Copies `.env.example` to `.env`
7. **Service Start**: Launches containers with `docker compose up -d`

### Platform Notes
- Optimized for Debian/Ubuntu (uses `apt`)
- Can be adapted for other Linux distributions
- macOS and Windows require manual setup

## Common Development Tasks

### Adding New Services to Proxy
1. Edit `docker-compose.yml` to add new service
2. Set appropriate profile if optional
3. Add Traefik labels for routing
4. Connect to `traefik-proxy` network

### Enabling/Disabling Services
Edit `COMPOSE_PROFILES` in `.env`, then:
```bash
docker compose up -d  # Applies profile changes
```

### Regenerating Certificates
```bash
rm certs/local-*.pem
mkcert -key-file certs/local-key.pem \
  -cert-file certs/local-cert.pem \
  "localhost" "*.docker.localhost" "127.0.0.1" "::1"
chmod 644 certs/local-cert.pem certs/local-key.pem
docker compose restart traefik
```

### Viewing Traefik Logs
```bash
docker logs traefik
docker logs -f traefik  # Follow mode
```

## Integration with Other Projects

Projects should follow this pattern in their `compose.yml`:

```yaml
services:
  app:
    image: my-app:latest
    networks:
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.my-app.rule=Host(`my-app.docker.localhost`)"
      - "traefik.http.routers.my-app.tls=true"
    # NO ports section needed

networks:
  traefik-proxy:
    external: true
```

## Security Considerations

- **Local CA**: Only trusted on machines where `mkcert -install` was run
- **Network Isolation**: Uses Docker network isolation
- **No Public Exposure**: Binds only to localhost
- **Private Keys**: Kept in git-ignored `certs/` directory
- **Container Security**: Uses `no-new-privileges` security option

## Troubleshooting Guide

### Common Issues

1. **"traefik-proxy network not found"**
   - Run: `docker network create traefik-proxy`

2. **Certificate warnings in browser**
   - Run: `mkcert -install` to trust local CA
   - Restart browser

3. **Service not routing**
   - Check labels in service definition
   - Verify service is on `traefik-proxy` network
   - Check Traefik dashboard for registered routers

4. **Port already in use**
   - Check if another Traefik instance is running
   - Check for other services on ports 80/443

## File Modification Guidelines

### When modifying docker-compose.yml:
- Maintain profile structure for optional services
- Keep Traefik labels consistent with naming convention
- Ensure all services join `traefik-proxy` network
- Add volumes for persistent data

### When modifying setup.sh:
- Maintain error handling (`set -e`)
- Use logging functions for consistency
- Test on clean system
- Update dependency checks for new requirements

### When modifying README.md:
- Keep usage examples up to date
- Document any new profiles/services
- Update troubleshooting section

## Development Workflow

When assisting with this project, consider:

1. **Profile Management**: Services can be toggled via profiles
2. **Network Requirements**: All proxied services need `traefik-proxy` network
3. **Label Convention**: Use consistent naming in Traefik labels
4. **Certificate Scope**: Wildcards only work for `*.docker.localhost`
5. **Platform Awareness**: Primary target is Debian/Ubuntu Linux

## Additional Context

- **Author**: Filip "fkrzski" Krzyżanowski
- **License**: MIT
- **Funding**: GitHub Sponsors (@fkrzski)
- **Primary Use Case**: Local development environment standardization
- **Design Philosophy**: Single source of truth for local SSL and routing

## AI Assistant Guidelines

When helping with this project:

1. **Suggest** label-based routing over port mapping
2. **Recommend** profile-based service organization
3. **Maintain** the external network pattern
4. **Preserve** security options and restart policies
5. **Consider** cross-project compatibility in changes
6. **Validate** that new services follow the established patterns
7. **Document** any new profiles or services in README.md
